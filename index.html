<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alarm & Downtime Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* … your existing styles … */
  </style>
</head>
<body>

  <div class="filter-row">
    <!-- View selector -->
    <div>
      <label for="viewSelect">View</label>
      <select id="viewSelect">
        <option value="alerts">Alerts</option>
        <option value="downtime">Downtime</option>
      </select>
    </div>

    <!-- Existing Start date -->
    <div>
      <label for="startDate">Start</label>
      <input type="date" id="startDate">
    </div>

    <!-- Existing End date -->
    <div>
      <label for="endDate">End</label>
      <input type="date" id="endDate">
    </div>

    <div>
      <button onclick="fetchData()">Generate</button>
    </div>
  </div>

  <div class="summary-box">
    <div style="flex: 1;">
      <span>Total Records: <span id="totalCount">0</span></span>
      &nbsp;|&nbsp;
      <span>Most Frequent: <span id="mostFrequent">-</span></span>
    </div>
    <div>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
  </div>

  <div style="text-align: right; margin: 1rem 2.5%;">
    <button onclick="toggleView()" id="toggleBtn">Switch to Pareto Chart</button>
  </div>

  <!-- TABLE VIEW -->
  <div id="tableView">
    <table id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody">
        <tr><td colspan="5">Select “Generate” to load data</td></tr>
      </tbody>
    </table>
  </div>

  <!-- PARETO VIEW -->
  <div id="chartView" style="display: none;">
    <div id="paretoChart" style="width: 95%; height: 400px; margin: auto;"></div>
  </div>

  <p class="error" id="errorMsg"></p>

  <script>
    const urlParams    = new URLSearchParams(window.location.search);
    const jwt          = urlParams.get("token");
    const deviceId     = urlParams.get("deviceId");
    const baseUrl      = "https://thingsboard.cloud/api";
    const viewSelect   = document.getElementById("viewSelect");
    const tableHead    = document.getElementById("tableHead");
    const tableBody    = document.getElementById("tableBody");
    const totalCountEl = document.getElementById("totalCount");
    const mostFreqEl   = document.getElementById("mostFrequent");
    let currentData    = [];

    if (!jwt || !deviceId) {
      document.body.innerHTML = '<div class="error">Error: token and deviceId are required in URL.</div>';
      throw new Error('Missing token or deviceId');
    }

    function getTelemetryKeys() {
      if (viewSelect.value === 'alerts') {
        return ['Alarm_Code','Alarm_Description','Alarm_Level'];
      } else {
        return ['Downtime_Start_Time','Downtime_End_Time','Downtime_Reason_Code','Downtime_Duration'];
      }
    }

    function buildTableHead() {
      const mode = viewSelect.value;
      let headers;
      if (mode === 'alerts') {
        headers = ['Sr.No.','Time','Description','Code','Level'];
      } else {
        headers = ['Sr.No.','Start Time','End Time','Reason Code','Duration(s)'];
      }
      tableHead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
    }

    async function fetchData() {
      tableBody.innerHTML = `<tr><td colspan="5">Loading…</td></tr>`;
      document.getElementById('errorMsg').textContent = '';
      currentData = [];

      const startTs = new Date(document.getElementById('startDate').value).getTime();
      const end = new Date(document.getElementById('endDate').value);
      end.setHours(23,59,59,999);
      const endTs = end.getTime();

      const keys = getTelemetryKeys().join(',');
      try {
        const res = await fetch(
          `${baseUrl}/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${keys}` +
          `&startTs=${startTs}&endTs=${endTs}&limit=1000&agg=NONE`,
          { headers: { "X-Authorization": `Bearer ${jwt}` } }
        );
        const json = await res.json();

        // transpose timeseries into array of records
        const raw = {};
        getTelemetryKeys().forEach(k => raw[k] = json[k] || []);
        const len = raw[ Object.keys(raw)[0] ].length;

        for (let i=0; i<len; i++) {
          const rec = { ts: raw[Object.keys(raw)[0]][i].ts };
          Object.keys(raw).slice(1).forEach((k,j) => {
            rec[k] = raw[k][i]?.value ?? '-';
          });
          // flatten for ease:
          if (viewSelect.value === 'alerts') {
            currentData.push({
              ts: rec.ts,
              description: rec['Alarm_Description'],
              code:        rec['Alarm_Code'],
              level:       rec['Alarm_Level']
            });
          } else {
            currentData.push({
              ts:          rec.ts,
              start:       rec['Downtime_Start_Time'],
              end:         rec['Downtime_End_Time'],
              reason:      rec['Downtime_Reason_Code'],
              duration:    rec['Downtime_Duration']
            });
          }
        }

        renderTable();
        renderSummary();
      } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="5">Failed to fetch data</td></tr>`;
        console.error(err);
      }
    }

    function renderTable() {
      buildTableHead();
      if (!currentData.length) {
        tableBody.innerHTML = `<tr><td colspan="5">No records found</td></tr>`;
        return;
      }
      tableBody.innerHTML = '';
      currentData.forEach((r,i) => {
        let cols;
        if (viewSelect.value === 'alerts') {
          cols = [
            i+1,
            new Date(r.ts).toLocaleString(),
            r.description,
            r.code,
            r.level
          ];
        } else {
          cols = [
            i+1,
            new Date(r.start).toLocaleString(),
            new Date(r.end).toLocaleString(),
            r.reason,
            r.duration
          ];
        }
        const row = `<tr>${cols.map(c => `<td>${c}</td>`).join('')}</tr>`;
        tableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    function renderSummary() {
      totalCountEl.textContent = currentData.length;
      if (!currentData.length) {
        mostFreqEl.textContent = '-';
        return;
      }
      // pick the field to tally
      const key = viewSelect.value === 'alerts' ? 'code' : 'reason';
      const freq = {};
      currentData.forEach(r => {
        const v = r[key] || '-';
        freq[v] = (freq[v]||0) + 1;
      });
      const [val, count] = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
      mostFreqEl.textContent = `${val} (${count} times)`;
    }

    function toggleView() {
      const t = document.getElementById('tableView');
      const c = document.getElementById('chartView');
      const btn = document.getElementById('toggleBtn');
      if (t.style.display === 'none') {
        t.style.display = 'block';
        c.style.display = 'none';
        btn.textContent = 'Switch to Pareto Chart';
      } else {
        t.style.display = 'none';
        c.style.display = 'block';
        btn.textContent = 'Switch to Table View';
        drawPareto();
      }
    }

    function drawPareto() {
      if (!currentData.length) return;
      const key = viewSelect.value === 'alerts' ? 'code' : 'reason';
      const freq = {};
      currentData.forEach(r => freq[r[key]] = (freq[r[key]]||0) + 1);
      const dataArr = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
      const labels = dataArr.map(d=>d[0]), counts = dataArr.map(d=>d[1]);
      const cumulative = counts.reduce((a,v,i)=>{ a.push((a[i-1]||0)+v); return a; }, []);
      const pct = cumulative.map(v=>v/cumulative.slice(-1)[0]*100);

      const trace1 = { x: labels, y: counts, type:'bar', name:'Frequency' };
      const trace2 = { x: labels, y: pct, yaxis:'y2', type:'scatter', mode:'lines+markers', name:'Cumulative %' };
      const layout = {
        yaxis2:{ overlaying:'y', side:'right', range:[0,100] },
        margin:{ t:40 }
      };
      Plotly.newPlot('paretoChart', [trace1,trace2], layout);
    }

    function downloadCSV() {
      const headers = viewSelect.value==='alerts'
        ? ['Sr.No.','Time','Description','Code','Level']
        : ['Sr.No.','Start','End','Reason','Duration'];
      const rows = [headers].concat(
        currentData.map((r,i) => (
          viewSelect.value==='alerts'
            ? [i+1, new Date(r.ts).toLocaleString(), r.description, r.code, r.level]
            : [i+1, new Date(r.start).toLocaleString(), new Date(r.end).toLocaleString(), r.reason, r.duration]
        ))
      );
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = viewSelect.value + '_data.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>

</body>
</html>
